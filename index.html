<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Stream + Chat + Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
    background: #121212;
    color: white;
  }
  #chat-container {
    width: 320px;
    background: #222;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  #chat {
    flex-grow: 1;
    overflow-y: auto;
    background: #111;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .chat-message {
    margin-bottom: 10px;
  }
  .chat-message strong {
    color: #ffb400;
  }
  #chat-input {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    border-radius: 4px;
    border: none;
    outline: none;
  }
  #dashboard {
    width: 300px;
    background: #222;
    color: white;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  #dashboard button {
    margin: 10px 0;
    padding: 10px;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    background: #444;
    color: white;
    transition: background 0.3s;
  }
  #dashboard button:hover:not(:disabled) {
    background: #ffb400;
    color: black;
  }
  #dashboard button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  #user-info {
    margin-bottom: 15px;
  }
  #stream-container {
    flex-grow: 1;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  video#screen-video {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
    background: black;
  }
</style>
</head>
<body>

<div id="chat-container">
  <div id="chat"></div>
  <input id="chat-input" placeholder="Type a message..." disabled />
</div>

<div id="stream-container">
  <video id="screen-video" autoplay muted></video>
</div>

<div id="dashboard">
  <div id="user-info">Not signed in</div>
  <button id="sign-in-btn">Sign in with Google</button>
  <button id="sign-out-btn" style="display:none;">Sign Out</button>
  <button id="start-stream-btn" disabled title="Only realgyjs@gmail.com can share screen">Start Screen Share</button>
  <button id="stop-stream-btn" disabled>Stop Screen Share</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCq74S-8b4maDXEKkDXwoaz28Y_Qf0N_34",
    authDomain: "livestreamchat-268a9.firebaseapp.com",
    databaseURL: "https://livestreamchat-268a9-default-rtdb.firebaseio.com",
    projectId: "livestreamchat-268a9",
    storageBucket: "livestreamchat-268a9.firebasestorage.app",
    messagingSenderId: "761482927725",
    appId: "1:761482927725:web:7d525941da69c424bb6964"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const signInBtn = document.getElementById('sign-in-btn');
  const signOutBtn = document.getElementById('sign-out-btn');
  const userInfo = document.getElementById('user-info');
  const startStreamBtn = document.getElementById('start-stream-btn');
  const stopStreamBtn = document.getElementById('stop-stream-btn');
  const chatInput = document.getElementById('chat-input');
  const chatDiv = document.getElementById('chat');
  const screenVideo = document.getElementById('screen-video');

  let currentUser = null;
  let screenStream = null;

  signInBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  };

  signOutBtn.onclick = () => {
    auth.signOut();
  };

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user) {
      userInfo.textContent = `Signed in as: ${user.displayName} (${user.email})`;
      signInBtn.style.display = 'none';
      signOutBtn.style.display = 'block';
      chatInput.disabled = false;

      // Only enable screen sharing for the allowed email
      if(user.email === 'realgyjs@gmail.com') {
        startStreamBtn.disabled = false;
        startStreamBtn.title = 'Start Screen Share';
      } else {
        startStreamBtn.disabled = true;
        startStreamBtn.title = 'Only realgyjs@gmail.com can share screen';
      }
    } else {
      userInfo.textContent = 'Not signed in';
      signInBtn.style.display = 'block';
      signOutBtn.style.display = 'none';
      startStreamBtn.disabled = true;
      stopStreamBtn.disabled = true;
      chatInput.disabled = true;
      screenVideo.srcObject = null;
      stopScreenShare();
      chatDiv.innerHTML = '';
    }
  });

  startStreamBtn.onclick = async () => {
    if(currentUser?.email !== 'realgyjs@gmail.com') return alert('You do not have permission to share screen');
    try {
      screenStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
      screenVideo.srcObject = screenStream;
      startStreamBtn.disabled = true;
      stopStreamBtn.disabled = false;
    } catch(err) {
      alert('Failed to get display media: ' + err.message);
    }
  };

  stopStreamBtn.onclick = () => {
    stopScreenShare();
  };

  function stopScreenShare() {
    if(screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      screenVideo.srcObject = null;
      screenStream = null;
      // Re-enable start only if allowed
      if(currentUser?.email === 'realgyjs@gmail.com') {
        startStreamBtn.disabled = false;
      }
      stopStreamBtn.disabled = true;
    }
  }

  // Chat system logic
  const chatRef = db.ref('chat/messages');

  chatRef.limitToLast(100).on('child_added', snapshot => {
    const msg = snapshot.val();
    if(!msg) return;
    appendMessage(msg.name, msg.text);
  });

  function appendMessage(name, text) {
    const div = document.createElement('div');
    div.classList.add('chat-message');
    div.innerHTML = `<strong>${escapeHTML(name)}:</strong> ${escapeHTML(text)}`;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  chatInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && chatInput.value.trim() && currentUser) {
      const message = chatInput.value.trim();
      chatInput.value = '';
      chatRef.push({
        name: currentUser.displayName,
        text: message,
        timestamp: Date.now()
      });
    }
  });
</script>

</body>
</html>
