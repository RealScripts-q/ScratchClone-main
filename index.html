<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Stream with Replay</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #222; color: #eee; }
  #loginScreen, #dashboard { padding: 10px; }
  #dashboard { display: none; flex-direction: column; }
  #ownerControls, #viewerArea { margin-top: 10px; }
  #livePreviewOwner, #livePreviewUser { display: none; margin-top: 10px; }
  video { border: 1px solid #444; border-radius: 4px; background: black; }
  #ownerStreamVideo { width: 320px; height: 180px; }
  #replayVideo { width: 640px; height: 360px; margin-top: 10px; display:none; }
  #chat { max-height: 200px; overflow-y: auto; border: 1px solid #555; background: #111; padding: 5px; }
  #inputArea { margin-top: 10px; display: none; }
  #inputArea input { width: 80%; padding: 5px; }
  #inputArea button { padding: 5px 10px; }
  .chat-message { margin-bottom: 5px; }
  .chat-message img { width: 24px; height: 24px; vertical-align: middle; border-radius: 50%; margin-right: 5px; }
  #ownerInfo { font-size: 14px; margin-top: 5px; color: #ccc; }
  #viewerCount, #viewerCountUser { margin-top: 5px; }
  button { cursor: pointer; }
</style>
</head>
<body>
<div id="loginScreen">
  <button id="loginBtn">Login with Google</button>
</div>

<div id="dashboard">
  <div id="ownerControls">
    <div id="createLiveForm">
      <input id="liveNameInput" placeholder="Stream Name" />
      <input id="liveDescInput" placeholder="Stream Description" />
      <button id="createLiveBtn">Start Live Stream</button>
      <button id="endLiveBtn" style="display:none;">End Stream</button>
    </div>
    <div id="livePreviewOwner">
      <video id="ownerStreamVideo" autoplay muted></video>
      <div id="ownerInfo">
        <div id="ownerLiveName"></div>
        <div id="ownerLiveDesc"></div>
      </div>
      <div id="viewerCount">üëÅÔ∏è Viewers: 0</div>
    </div>
  </div>

  <div id="viewerArea">
    <div id="livePreviewUser">
      <!-- No name/desc here -->
      <div id="viewerCountUser">üëÅÔ∏è Viewers: 0</div>
      <video id="replayVideo" controls></video>
    </div>

    <div id="chat"></div>

    <div id="inputArea">
      <input id="msgInput" placeholder="Type your message" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <button id="logoutBtn">Logout</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Firebase config (use your own)
  const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    databaseURL: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const STREAM_OWNER_EMAIL = 'realgyjs@gmail.com';

  const loginScreen = document.getElementById('loginScreen');
  const dashboard = document.getElementById('dashboard');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Owner elements
  const createLiveForm = document.getElementById('createLiveForm');
  const liveNameInput = document.getElementById('liveNameInput');
  const liveDescInput = document.getElementById('liveDescInput');
  const createLiveBtn = document.getElementById('createLiveBtn');
  const endLiveBtn = document.getElementById('endLiveBtn');

  const livePreviewOwner = document.getElementById('livePreviewOwner');
  const ownerStreamVideo = document.getElementById('ownerStreamVideo');
  const ownerLiveName = document.getElementById('ownerLiveName');
  const ownerLiveDesc = document.getElementById('ownerLiveDesc');
  const viewerCount = document.getElementById('viewerCount');

  // Viewer elements
  const livePreviewUser = document.getElementById('livePreviewUser');
  const replayVideo = document.getElementById('replayVideo');
  const viewerCountUser = document.getElementById('viewerCountUser');

  // Chat
  const chatDiv = document.getElementById('chat');
  const inputArea = document.getElementById('inputArea');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let liveStreamDataRef = null;
  let liveMessagesRef = null;
  let liveViewersRef = null;
  let viewerRef = null;

  let ownerStream = null;
  let liveActive = false;
  let mediaRecorder = null;
  let recordedChunks = [];

  // --- Login and Logout ---
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  };
  logoutBtn.onclick = () => {
    if (currentUser && currentUser.email === STREAM_OWNER_EMAIL) {
      endLiveStream();
    }
    auth.signOut();
  };

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      loginScreen.style.display = 'none';
      dashboard.style.display = 'flex';

      if (user.email === STREAM_OWNER_EMAIL) {
        // Owner UI
        createLiveForm.style.display = 'flex';
        livePreviewOwner.style.display = 'none';
        livePreviewUser.style.display = 'none';
        inputArea.style.display = 'none';
        chatDiv.innerHTML = '<em>Create a live stream to start chatting</em>';
        endLiveBtn.style.display = 'none';
        setupOwnerListeners();
      } else {
        // Viewer UI
        createLiveForm.style.display = 'none';
        livePreviewOwner.style.display = 'none';
        livePreviewUser.style.display = 'none';
        inputArea.style.display = 'none';
        chatDiv.innerHTML = '<em>Waiting for a live stream...</em>';
        setupViewerListeners();
      }
    } else {
      currentUser = null;
      loginScreen.style.display = 'flex';
      dashboard.style.display = 'none';
      cleanupListeners();
    }
  });

  // --- Owner starts live stream ---
  createLiveBtn.onclick = async () => {
    const name = liveNameInput.value.trim();
    const desc = liveDescInput.value.trim();
    if (!name) return alert("Enter a live stream name.");

    if (liveActive) {
      alert("You already have an active live stream.");
      return;
    }

    try {
      ownerStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      ownerStreamVideo.srcObject = ownerStream;

      // Start MediaRecorder to save stream for replay
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(ownerStream);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.start();

      // Create live stream data in DB
      liveStreamDataRef = db.ref('liveStreams/owner');
      await liveStreamDataRef.set({
        name,
        description: desc,
        owner: currentUser.uid,
        startedAt: Date.now(),
        viewerCount: 0,
        endedAt: null
      });

      liveMessagesRef = db.ref('liveMessages/owner');
      liveViewersRef = db.ref('liveViewers/owner');

      liveActive = true;

      createLiveForm.style.display = 'none';
      livePreviewOwner.style.display = 'flex';
      inputArea.style.display = 'flex';
      chatDiv.innerHTML = '';
      endLiveBtn.style.display = 'inline-block';

      ownerLiveName.textContent = name;
      ownerLiveDesc.textContent = desc;
      updateViewerCountUI(0);

      setupChatListeners();
      setupViewerCountListeners();
      addViewer();

      // When stream ends (user stops sharing)
      ownerStream.getVideoTracks()[0].onended = () => {
        endLiveStream();
      };
    } catch (e) {
      alert("Failed to get screen capture: " + e.message);
    }
  };

  // --- Owner ends live stream manually ---
  endLiveBtn.onclick = () => {
    endLiveStream();
  };

  // --- End live stream ---
  async function endLiveStream() {
    if (!liveActive) return;

    liveActive = false;

    // Stop media recorder and save blob
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      await new Promise(resolve => mediaRecorder.onstop = resolve);
    }

    // Remove live stream data from DB (mark endedAt)
    if (liveStreamDataRef) {
      await liveStreamDataRef.update({ endedAt: Date.now() });
    }

    // Stop all tracks
    if (ownerStream) {
      ownerStream.getTracks().forEach(t => t.stop());
      ownerStream = null;
    }

    // Show replay video to owner
    showReplayVideo();

    // Clean up DB refs
    if (liveViewersRef) liveViewersRef.remove();
    if (liveMessagesRef) liveMessagesRef.off();
    if (liveViewersRef) liveViewersRef.off();
    if (viewerRef) {
      viewerRef.remove();
      viewerRef = null;
    }

    createLiveForm.style.display = 'flex';
    livePreviewOwner.style.display = 'none';
    inputArea.style.display = 'none';
    endLiveBtn.style.display = 'none';

    ownerLiveName.textContent = '';
    ownerLiveDesc.textContent = '';

    chatDiv.innerHTML = '<em>Live stream ended. Showing replay below.</em>';
  }

  // --- Show replay video and chat history ---
  function showReplayVideo() {
    if (recordedChunks.length === 0) return;
    const superBuffer = new Blob(recordedChunks, { type: 'video/webm' });
    replayVideo.src = URL.createObjectURL(superBuffer);
    replayVideo.style.display = 'block';
    livePreviewUser.style.display = 'flex';
    livePreviewOwner.style.display = 'none';

    // Load chat history for replay
    loadChatHistory();
  }

  // --- Viewer setup ---
  async function setupViewerListeners() {
    liveStreamDataRef = db.ref('liveStreams/owner');
    liveMessagesRef = db.ref('liveMessages/owner');
    liveViewersRef = db.ref('liveViewers/owner');

    // Listen for live stream data changes
    liveStreamDataRef.on('value', snapshot => {
      const data = snapshot.val();
      if (!data || data.endedAt) {
        // No live or ended
        livePreviewUser.style.display = 'none';
        inputArea.style.display = 'none';
        chatDiv.innerHTML = '<em>No live stream currently.</em>';
        replayVideo.style.display = 'none';
        viewerCountUser.textContent = 'üëÅÔ∏è Viewers: 0';
      } else {
        // Live active
        livePreviewUser.style.display = 'flex';
        inputArea.style.display = 'flex';
        chatDiv.innerHTML = '';
        replayVideo.style.display = 'none';
        viewerCountUser.textContent = 'üëÅÔ∏è Viewers: ' + (data.viewerCount || 0);
      }
    });

    setupChatListeners();

    // Register viewer presence
    addViewer();

    setupViewerCountListeners();
  }

  // --- Chat listeners ---
  function setupChatListeners() {
    if (!liveMessagesRef) return;

    liveMessagesRef.off();
    liveMessagesRef.on('child_added', snapshot => {
      const msg = snapshot.val();
      if (!msg) return;
      appendChatMessage(msg);
    });
  }

  // --- Append chat message ---
  function appendChatMessage(msg) {
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.innerHTML = `
      <img src="${msg.photoURL || 'https://i.pravatar.cc/24'}" alt="avatar" />
      <strong>${msg.name}:</strong> ${escapeHtml(msg.text)}
    `;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // --- Load chat history on replay ---
  async function loadChatHistory() {
    if (!liveMessagesRef) return;
    chatDiv.innerHTML = '';
    const snapshot = await liveMessagesRef.once('value');
    const msgs = snapshot.val() || {};
    Object.values(msgs).forEach(msg => {
      appendChatMessage(msg);
    });
    inputArea.style.display = 'none'; // disable input on replay
  }

  // --- Viewer count listeners ---
  function setupViewerCountListeners() {
    if (!liveViewersRef || !liveStreamDataRef) return;

    // Count viewers
    liveViewersRef.on('value', snapshot => {
      const count = snapshot.numChildren();
      viewerCount.textContent = 'üëÅÔ∏è Viewers: ' + count;
      viewerCountUser.textContent = 'üëÅÔ∏è Viewers: ' + count;

      // Update viewer count in live stream data
      liveStreamDataRef.update({ viewerCount: count });
    });
  }

  // --- Add viewer presence ---
  function addViewer() {
    if (!liveViewersRef || !currentUser) return;

    viewerRef = liveViewersRef.child(currentUser.uid);
    viewerRef.set(true);
    viewerRef.onDisconnect().remove();
  }

  // --- Chat send ---
  sendBtn.onclick = () => {
    sendMessage();
  };
  msgInput.onkeypress = (e) => {
    if (e.key === 'Enter') sendMessage();
  };
  function sendMessage() {
    if (!msgInput.value.trim()) return;
    if (!liveMessagesRef) return;

    liveMessagesRef.push({
      uid: currentUser.uid,
      name: currentUser.displayName,
      photoURL: currentUser.photoURL,
      text: msgInput.value.trim(),
      timestamp: Date.now()
    });
    msgInput.value = '';
  }

  // --- Cleanup listeners ---
  function cleanupListeners() {
    if (liveStreamDataRef) liveStreamDataRef.off();
    if (liveMessagesRef) liveMessagesRef.off();
    if (liveViewersRef) liveViewersRef.off();
    if (viewerRef) viewerRef.remove();
  }

  // --- Utility ---
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }
</script>
</body>
</html>
