<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Stream with Thumbnail Upload and Camera/Mic Toggle</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    #container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    #videoContainer { position: relative; width: 640px; height: 360px; background: black; margin-bottom: 10px; }
    video { width: 100%; height: 100%; border-radius: 8px; background: black; }
    #thumbnailPreview { width: 150px; height: 84px; object-fit: cover; border-radius: 6px; margin-top: 10px; }
    #chat { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fafafa; border-radius: 6px; margin-top: 10px; }
    #chat p { margin: 5px 0; }
    button { margin-right: 10px; padding: 8px 12px; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    #ownerControls { margin-bottom: 20px; }
    input[type="file"] { margin-top: 10px; }
  </style>
</head>
<body>
  <div id="container">
    <h2>Live Stream with Thumbnail Upload & Camera/Mic Toggle</h2>

    <div id="authSection">
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
      <p id="userInfo"></p>
    </div>

    <div id="ownerControls" style="display:none;">
      <h3>Create New Stream</h3>
      <input type="text" id="streamName" placeholder="Stream Name" /><br />
      <input type="text" id="streamDesc" placeholder="Stream Description" /><br />
      <label>Choose Thumbnail Image:</label><br />
      <input type="file" id="thumbInput" accept="image/*" /><br />
      <img id="thumbnailPreview" alt="Thumbnail Preview" src="" /><br />
      <button id="createStreamBtn">Create Stream</button>
    </div>

    <hr />

    <div id="streamsListSection" style="display:none;">
      <h3>Active Streams</h3>
      <ul id="streamsList"></ul>
    </div>

    <hr />

    <div id="streamView" style="display:none;">
      <h3 id="streamTitle"></h3>
      <p id="streamDescText"></p>
      <img id="streamThumbnail" src="" alt="Stream Thumbnail" style="width:200px; height:112px; object-fit:cover; border-radius:6px; margin-bottom:10px;" />

      <div id="videoContainer">
        <video id="liveVideo" autoplay muted playsinline></video>
      </div>

      <div id="streamControls" style="display:none;">
        <button id="toggleCamBtn">Turn Camera Off</button>
        <button id="toggleMicBtn">Turn Mic Off</button>
      </div>

      <div id="chatSection">
        <h4>Chat</h4>
        <div id="chat"></div>
        <input type="text" id="msgInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ====== Your Firebase config ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // DOM elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const ownerControls = document.getElementById('ownerControls');
    const streamNameInput = document.getElementById('streamName');
    const streamDescInput = document.getElementById('streamDesc');
    const thumbInput = document.getElementById('thumbInput');
    const thumbnailPreview = document.getElementById('thumbnailPreview');
    const createStreamBtn = document.getElementById('createStreamBtn');
    const streamsListSection = document.getElementById('streamsListSection');
    const streamsList = document.getElementById('streamsList');
    const streamView = document.getElementById('streamView');
    const streamTitle = document.getElementById('streamTitle');
    const streamDescText = document.getElementById('streamDescText');
    const streamThumbnail = document.getElementById('streamThumbnail');
    const liveVideo = document.getElementById('liveVideo');
    const streamControls = document.getElementById('streamControls');
    const toggleCamBtn = document.getElementById('toggleCamBtn');
    const toggleMicBtn = document.getElementById('toggleMicBtn');
    const chat = document.getElementById('chat');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentUser = null;
    let currentStreamId = null;
    let currentStreamData = null;

    // Media stream and tracks
    let mediaStream = null;
    let videoTrack = null;
    let audioTrack = null;

    // Thumbnail image file
    let selectedThumbFile = null;
    let uploadedThumbURL = '';

    // Owner email - change as needed
    const OWNER_EMAIL = "realgyjs@gmail.com";

    // Auth state listener
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        userInfo.textContent = `Logged in as: ${user.displayName || user.email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

        // Show owner controls if owner
        if (user.email === OWNER_EMAIL) {
          ownerControls.style.display = 'block';
        } else {
          ownerControls.style.display = 'none';
        }

        streamsListSection.style.display = 'block';
        loadStreams();
      } else {
        userInfo.textContent = '';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        ownerControls.style.display = 'none';
        streamsListSection.style.display = 'none';
        streamView.style.display = 'none';
      }
    });

    // Login
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    };

    // Logout
    logoutBtn.onclick = () => auth.signOut();

    // Thumbnail input change
    thumbInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }
      selectedThumbFile = file;

      // Preview
      const reader = new FileReader();
      reader.onload = e => {
        thumbnailPreview.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    // Create Stream
    createStreamBtn.onclick = async () => {
      const name = streamNameInput.value.trim();
      const desc = streamDescInput.value.trim();
      if (!name || !desc) {
        alert('Please enter stream name and description.');
        return;
      }
      if (!selectedThumbFile) {
        alert('Please select a thumbnail image.');
        return;
      }
      createStreamBtn.disabled = true;

      // Upload thumbnail to Firebase Storage
      try {
        const storageRef = storage.ref();
        const thumbRef = storageRef.child(`thumbnails/${Date.now()}_${selectedThumbFile.name}`);
        const snapshot = await thumbRef.put(selectedThumbFile);
        uploadedThumbURL = await snapshot.ref.getDownloadURL();

        // Save stream info in DB
        const newStreamRef = db.ref('streams').push();
        await newStreamRef.set({
          name,
          description: desc,
          thumbnail: uploadedThumbURL,
          owner: currentUser.uid,
          active: true,
          streamUrl: '', // placeholder
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        alert('Stream created successfully!');
        streamNameInput.value = '';
        streamDescInput.value = '';
        thumbInput.value = '';
        thumbnailPreview.src = '';
        selectedThumbFile = null;
        uploadedThumbURL = '';
        createStreamBtn.disabled = false;
        loadStreams();

      } catch (err) {
        console.error(err);
        alert('Failed to upload thumbnail or create stream.');
        createStreamBtn.disabled = false;
      }
    };

    // Load streams list
    function loadStreams() {
      streamsList.innerHTML = '';
      db.ref('streams').orderByChild('active').equalTo(true).on('value', snapshot => {
        streamsList.innerHTML = '';
        if (!snapshot.exists()) {
          streamsList.innerHTML = '<li>No active streams.</li>';
          return;
        }
        snapshot.forEach(childSnap => {
          const stream = childSnap.val();
          const li = document.createElement('li');
          li.style.cursor = 'pointer';
          li.textContent = stream.name;
          li.onclick = () => openStream(childSnap.key, stream);
          streamsList.appendChild(li);
        });
      });
    }

    // Open stream view
    async function openStream(streamId, streamData) {
      currentStreamId = streamId;
      currentStreamData = streamData;

      streamsListSection.style.display = 'none';
      streamView.style.display = 'block';

      streamTitle.textContent = streamData.name;
      streamDescText.textContent = streamData.description;
      streamThumbnail.src = streamData.thumbnail;

      chat.innerHTML = '';

      // Show chat + controls if owner
      if (currentUser && currentUser.uid === streamData.owner) {
        streamControls.style.display = 'block';
        await startLocalStream();
      } else {
        streamControls.style.display = 'none';
        // For demo, no remote streaming implementation
        liveVideo.srcObject = null;
        liveVideo.poster = streamData.thumbnail;
      }

      loadChat();
    }

    // Start local media stream for owner (simulate live stream)
    async function startLocalStream() {
      try {
        if (mediaStream) {
          // Already started
          return;
        }
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        liveVideo.srcObject = mediaStream;

        videoTrack = mediaStream.getVideoTracks()[0];
        audioTrack = mediaStream.getAudioTracks()[0];

        toggleCamBtn.textContent = 'Turn Camera Off';
        toggleMicBtn.textContent = 'Turn Mic Off';
      } catch (err) {
        alert('Could not access camera and mic: ' + err.message);
      }
    }

    // Toggle camera
    toggleCamBtn.onclick = () => {
      if (!videoTrack) return;
      videoTrack.enabled = !videoTrack.enabled;
      toggleCamBtn.textContent = videoTrack.enabled ? 'Turn Camera Off' : 'Turn Camera On';
    };

    // Toggle mic
    toggleMicBtn.onclick = () => {
      if (!audioTrack) return;
      audioTrack.enabled = !audioTrack.enabled;
      toggleMicBtn.textContent = audioTrack.enabled ? 'Turn Mic Off' : 'Turn Mic On';
    };

    // Chat system
    function loadChat() {
      const chatRef = db.ref(`messages/${currentStreamId}`);
      chatRef.off(); // remove old listeners

      chatRef.on('child_added', snap => {
        const msg = snap.val();
        const p = document.createElement('p');
        p.innerHTML = `<strong>${escapeHtml(msg.user)}:</strong> ${escapeHtml(msg.text)}`;
        chat.appendChild(p);
        chat.scrollTop = chat.scrollHeight;
      });
    }

    sendBtn.onclick = () => {
      sendMessage();
    };
    msgInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      const msgData = {
        user: currentUser.displayName || currentUser.email.split('@')[0],
        text,
        timestamp: Date.now()
      };
      db.ref(`messages/${currentStreamId}`).push(msgData);
      msgInput.value = '';
    }

    // Utility: Escape HTML for chat messages
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (m) => {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
        }
      });
    }
  </script>
</body>
</html>
