<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Share Stream with Chat</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
  }
  #streamView {
    display: flex; height: 100vh;
  }
  #videoContainer {
    flex: 2;
    background: #222;
    display: flex; justify-content: center; align-items: center;
    position: relative;
  }
  video {
    max-width: 100%; max-height: 100%;
    background: black;
  }
  #chatContainer {
    flex: 1;
    display: flex; flex-direction: column;
    border-left: 1px solid #444;
    background: #111;
    color: white;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .chat-message {
    margin-bottom: 8px;
  }
  #inputArea {
    display: flex;
    border-top: 1px solid #444;
  }
  #msgInput {
    flex: 1;
    padding: 10px;
    border: none;
    background: #222;
    color: white;
    font-size: 16px;
  }
  #sendBtn {
    background: #4CAF50;
    border: none;
    padding: 10px 15px;
    color: white;
    cursor: pointer;
  }
  #micControls {
    position: absolute;
    top: 10px;
    left: 10px;
  }
  #toggleMicBtn {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="streamView" style="display:none;">
  <div id="videoContainer">
    <video id="streamVideo" autoplay muted playsinline></video>
    <div id="micControls" style="display:none;">
      <button id="toggleMicBtn">Mute Mic</button>
    </div>
  </div>
  <div id="chatContainer">
    <div id="messages"><em>Loading chat...</em></div>
    <div id="inputArea" style="display:none;">
      <input type="text" id="msgInput" placeholder="Type your message" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  // Simulated owner check (replace with your auth check)
  const isOwner = true; // Change to false to test viewer mode

  const streamView = document.getElementById('streamView');
  const streamVideo = document.getElementById('streamVideo');
  const micControls = document.getElementById('micControls');
  const toggleMicBtn = document.getElementById('toggleMicBtn');
  const messagesDiv = document.getElementById('messages');
  const inputArea = document.getElementById('inputArea');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  let mediaStream = null;
  let micOn = true;

  async function startOwnerStream() {
    try {
      // Ask for screen share first
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      // Ask for mic audio
      const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

      // Combine audio and screen video tracks
      const combinedStream = new MediaStream([...screenStream.getVideoTracks(), ...audioStream.getAudioTracks()]);

      mediaStream = combinedStream;
      streamVideo.srcObject = mediaStream;

      micControls.style.display = 'block';
      inputArea.style.display = 'flex';

      updateMicButton();

    } catch (err) {
      alert('Failed to get screen and mic permissions: ' + err.message);
    }
  }

  function startViewerStream() {
    // For demo, no real stream â€” just black screen placeholder
    // In real app, you'd pull stream from server or WebRTC
    streamVideo.style.background = 'black';
    inputArea.style.display = 'flex';
    micControls.style.display = 'none';
  }

  toggleMicBtn.onclick = () => {
    if (!mediaStream) return;
    micOn = !micOn;
    mediaStream.getAudioTracks().forEach(track => track.enabled = micOn);
    updateMicButton();
  };

  function updateMicButton() {
    toggleMicBtn.textContent = micOn ? 'Mute Mic' : 'Unmute Mic';
    toggleMicBtn.style.background = micOn ? '#e74c3c' : '#27ae60';
  }

  sendBtn.onclick = () => {
    const msg = msgInput.value.trim();
    if (!msg) return;
    addChatMessage(isOwner ? 'Owner' : 'Viewer', msg);
    msgInput.value = '';
    // Here you'd send msg to your backend/chat system
  };

  function addChatMessage(user, message) {
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.textContent = `${user}: ${message}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  msgInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  // Init
  streamView.style.display = 'flex';

  if (isOwner) {
    startOwnerStream();
  } else {
    startViewerStream();
  }
</script>
</body>
</html>
