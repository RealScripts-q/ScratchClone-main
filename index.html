<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        #chat-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        #message-box {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
        }
        #message-box div {
            margin-bottom: 10px;
        }
        #message-box div .message {
            padding: 10px;
            border-radius: 5px;
            background-color: #f1f1f1;
        }
        #message-box div .user {
            font-weight: bold;
        }
        #send-message {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #send-button:hover {
            background-color: #0056b3;
        }
        .typing-indicator {
            font-size: 12px;
            color: gray;
        }
        .online-users {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
        }
        .dark-mode {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            cursor: pointer;
        }
        .dark-mode.active {
            background-color: #f1f1f1;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <button id="dark-mode-btn" class="dark-mode">ðŸŒ™</button>
        <h2>Private Chat Room</h2>
        <div id="message-box"></div>
        <div class="typing-indicator" id="typing-indicator"></div>
        <input type="text" id="send-message" placeholder="Type a message...">
        <button id="send-button">Send</button>
        <div class="online-users" id="online-users"></div>
        <br>
        <button id="create-room">Create Room</button>
        <div>
            <h3>Invite Link: <span id="invite-link"></span></h3>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB4HiV-vR8ZwqH2VIAT9HaPC--lPVN6B1U",
            authDomain: "memechat2-54d1d.firebaseapp.com",
            databaseURL: "https://memechat2-54d1d-default-rtdb.firebaseio.com",
            projectId: "memechat2-54d1d",
            storageBucket: "memechat2-54d1d.firebasestorage.app",
            messagingSenderId: "598300946052",
            appId: "1:598300946052:web:7eed3b96d89933b1159cd1"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentRoom = new URLSearchParams(window.location.search).get('room') || '';
        let userId = Math.random().toString(36).substring(7); // Random user ID
        let isDarkMode = false;

        // DOM Elements
        const messageBox = document.getElementById('message-box');
        const sendButton = document.getElementById('send-button');
        const sendMessage = document.getElementById('send-message');
        const typingIndicator = document.getElementById('typing-indicator');
        const onlineUsers = document.getElementById('online-users');
        const inviteLink = document.getElementById('invite-link');
        const darkModeBtn = document.getElementById('dark-mode-btn');
        const createRoomBtn = document.getElementById('create-room');

        // Initialize Chat Room
        if (currentRoom) {
            inviteLink.textContent = `${window.location.href}`;
            loadMessages(currentRoom);
            listenForTyping(currentRoom);
            updateOnlineUsers(currentRoom);
        }

        // Dark Mode Toggle
        darkModeBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.style.backgroundColor = isDarkMode ? '#333' : '#f5f5f5';
            document.body.style.color = isDarkMode ? '#fff' : '#333';
            darkModeBtn.classList.toggle('active', isDarkMode);
        });

        // Send Message
        sendButton.addEventListener('click', () => {
            if (sendMessage.value.trim() !== '') {
                const message = sendMessage.value.trim();
                const timestamp = new Date().toLocaleTimeString();
                sendMessage.value = '';

                database.ref('rooms/' + currentRoom).push({
                    userId: userId,
                    message: message,
                    timestamp: timestamp
                });
            }
        });

        // Listen for New Messages
        function loadMessages(room) {
            const roomRef = database.ref('rooms/' + room);
            roomRef.on('child_added', (snapshot) => {
                const messageData = snapshot.val();
                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `<div><span class="user">${messageData.userId}</span> <span class="timestamp">(${messageData.timestamp})</span></div>
                                        <div class="message">${messageData.message}</div>`;
                messageBox.appendChild(messageDiv);
                messageBox.scrollTop = messageBox.scrollHeight; // Auto-scroll to the latest message
            });
        }

        // Typing Indicator
        sendMessage.addEventListener('input', () => {
            if (sendMessage.value.trim() !== '') {
                database.ref('rooms/' + currentRoom + '/typing/' + userId).set(true);
            } else {
                database.ref('rooms/' + currentRoom + '/typing/' + userId).remove();
            }
        });

        function listenForTyping(room) {
            const typingRef = database.ref('rooms/' + room + '/typing');
            typingRef.on('value', (snapshot) => {
                let usersTyping = [];
                snapshot.forEach((childSnapshot) => {
                    if (childSnapshot.val()) {
                        usersTyping.push(childSnapshot.key);
                    }
                });

                if (usersTyping.length > 0) {
                    typingIndicator.textContent = `${usersTyping.join(', ')} is typing...`;
                } else {
                    typingIndicator.textContent = '';
                }
            });
        }

        // Online Users Counter
        function updateOnlineUsers(room) {
            const onlineRef = database.ref('rooms/' + room + '/online');
            onlineRef.on('value', (snapshot) => {
                onlineUsers.textContent = `Online Users: ${snapshot.numChildren()}`;
            });

            database.ref('rooms/' + room + '/online/' + userId).set(true);
            window.addEventListener('beforeunload', () => {
                database.ref('rooms/' + room + '/online/' + userId).remove();
            });
        }

        // Create Room and Generate Invite Link
        createRoomBtn.addEventListener('click', () => {
            const roomName = prompt("Enter a name for your room");
            if (roomName) {
                currentRoom = roomName;
                window.history.pushState(null, null, `?room=${roomName}`);
                inviteLink.textContent = `${window.location.href}`;
                loadMessages(roomName);
                listenForTyping(roomName);
                updateOnlineUsers(roomName);
            }
        });
    </script>

</body>
</html>
