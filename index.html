<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Stream + Chat + Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #dashboard {
    width: 300px;
    background: #222;
    color: white;
    display: flex;
    flex-direction: column;
    padding: 10px;
  }
  #dashboard button {
    margin: 10px 0;
    padding: 10px;
    font-size: 1rem;
    cursor: pointer;
  }
  #user-info {
    margin-bottom: 15px;
  }
  #stream-container {
    flex-grow: 1;
    background: #000;
    display: flex;
    flex-direction: column;
  }
  video {
    width: 100%;
    height: 50vh;
    background: black;
  }
  #chat {
    flex-grow: 1;
    background: #111;
    color: white;
    overflow-y: auto;
    padding: 10px;
  }
  #chat input {
    width: calc(100% - 20px);
    padding: 8px;
    font-size: 1rem;
  }
  .chat-message {
    margin-bottom: 10px;
  }
  .chat-message strong {
    color: #ffb400;
  }
</style>
</head>
<body>

<div id="dashboard">
  <div id="user-info">Not signed in</div>
  <button id="sign-in-btn">Sign in with Google</button>
  <button id="sign-out-btn" style="display:none;">Sign Out</button>
  <button id="start-stream-btn" disabled>Start Screen Share</button>
  <button id="stop-stream-btn" disabled>Stop Screen Share</button>

  <div style="margin-top: auto;">
    <input id="chat-input" placeholder="Type a message..." disabled />
  </div>
</div>

<div id="stream-container">
  <video id="screen-video" autoplay muted></video>
  <div id="chat"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCq74S-8b4maDXEKkDXwoaz28Y_Qf0N_34",
    authDomain: "livestreamchat-268a9.firebaseapp.com",
    databaseURL: "https://livestreamchat-268a9-default-rtdb.firebaseio.com",
    projectId: "livestreamchat-268a9",
    storageBucket: "livestreamchat-268a9.firebasestorage.app",
    messagingSenderId: "761482927725",
    appId: "1:761482927725:web:7d525941da69c424bb6964"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const signInBtn = document.getElementById('sign-in-btn');
  const signOutBtn = document.getElementById('sign-out-btn');
  const userInfo = document.getElementById('user-info');
  const startStreamBtn = document.getElementById('start-stream-btn');
  const stopStreamBtn = document.getElementById('stop-stream-btn');
  const chatInput = document.getElementById('chat-input');
  const chatDiv = document.getElementById('chat');
  const screenVideo = document.getElementById('screen-video');

  let currentUser = null;
  let screenStream = null;

  // Sign in with Google
  signInBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .catch(console.error);
  };

  // Sign out
  signOutBtn.onclick = () => {
    auth.signOut();
  };

  // Listen auth state
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user) {
      userInfo.textContent = `Signed in as: ${user.displayName}`;
      signInBtn.style.display = 'none';
      signOutBtn.style.display = 'block';
      startStreamBtn.disabled = false;
      chatInput.disabled = false;
    } else {
      userInfo.textContent = 'Not signed in';
      signInBtn.style.display = 'block';
      signOutBtn.style.display = 'none';
      startStreamBtn.disabled = true;
      stopStreamBtn.disabled = true;
      chatInput.disabled = true;
      screenVideo.srcObject = null;
      screenStream && stopScreenShare();
      chatDiv.innerHTML = '';
    }
  });

  // Start screen share
  startStreamBtn.onclick = async () => {
    try {
      screenStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
      screenVideo.srcObject = screenStream;
      startStreamBtn.disabled = true;
      stopStreamBtn.disabled = false;
    } catch(err) {
      alert('Failed to get display media: ' + err.message);
    }
  };

  // Stop screen share
  stopStreamBtn.onclick = () => {
    stopScreenShare();
  };

  function stopScreenShare() {
    if(screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      screenVideo.srcObject = null;
      screenStream = null;
      startStreamBtn.disabled = false;
      stopStreamBtn.disabled = true;
    }
  }

  // Chat system logic
  const chatRef = db.ref('chat/messages');

  // Listen for new chat messages
  chatRef.limitToLast(100).on('child_added', snapshot => {
    const msg = snapshot.val();
    if(!msg) return;
    appendMessage(msg.name, msg.text);
  });

  // Append message to chat div
  function appendMessage(name, text) {
    const div = document.createElement('div');
    div.classList.add('chat-message');
    div.innerHTML = `<strong>${escapeHTML(name)}:</strong> ${escapeHTML(text)}`;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Escape HTML to prevent XSS
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // Send chat message on Enter key
  chatInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && chatInput.value.trim() && currentUser) {
      const message = chatInput.value.trim();
      chatInput.value = '';
      chatRef.push({
        name: currentUser.displayName,
        text: message,
        timestamp: Date.now()
      });
    }
  });

</script>

</body>
</html>
