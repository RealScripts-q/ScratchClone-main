<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Chat System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
    }

    #startScreen, #groupJoin, #privateStart, #chatBox {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    #chatBox {
      display: none;
      height: 100vh;
      flex-direction: column;
      padding: 20px;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      width: 100%;
      max-width: 600px;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    #inputBox {
      display: flex;
      width: 100%;
      max-width: 600px;
    }

    #inputBox input[type="text"] {
      flex-grow: 1;
    }

    .message {
      margin-bottom: 10px;
    }

    .message strong {
      color: #007BFF;
    }
  </style>
</head>
<body>

  <!-- Start Chat Options -->
  <div id="startScreen" style="display: flex;">
    <h2>Start Chat</h2>
    <input id="startName" placeholder="Your Name" />
    <br />
    <button onclick="showGroupJoin()">Join Group Chat</button>
    <button onclick="showPrivateStart()">Start Private Chat</button>
  </div>

  <!-- Group Chat Join -->
  <div id="groupJoin">
    <h2>Join Group</h2>
    <input id="room" placeholder="Room Name" />
    <br />
    <button onclick="joinGroup()">Join</button>
  </div>

  <!-- Private Chat Start -->
  <div id="privateStart">
    <h2>Private Chat</h2>
    <input id="privateTo" placeholder="Other User's Name" />
    <br />
    <button onclick="startPrivate()">Start</button>
  </div>

  <!-- Chat Box -->
  <div id="chatBox">
    <div id="messages"></div>

    <div id="inputBox">
      <input id="messageInput" placeholder="Type your message..." />
      <input type="file" id="fileInput" onchange="handleFileUpload(event)" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    // TODO: Replace this config with your own Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let user = "";
    let room = "";
    let currentPath = "";

    function showGroupJoin() {
      user = document.getElementById("startName").value.trim();
      if (!user) return alert("Enter your name first.");
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("groupJoin").style.display = "flex";
    }

    function showPrivateStart() {
      user = document.getElementById("startName").value.trim();
      if (!user) return alert("Enter your name first.");
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("privateStart").style.display = "flex";
    }

    function joinGroup() {
      room = document.getElementById("room").value.trim();
      if (!room) return alert("Enter a room name.");
      startChat("rooms/" + room + "/messages");
      db.ref("rooms/" + room + "/users").push(user);
    }

    function startPrivate() {
      const otherUser = document.getElementById("privateTo").value.trim();
      if (!otherUser) return alert("Enter the other user's name.");
      const chatId = [user, otherUser].sort().join("_");
      room = chatId;
      startChat("privateChats/" + chatId + "/messages");
    }

    function startChat(path) {
      document.getElementById("groupJoin").style.display = "none";
      document.getElementById("privateStart").style.display = "none";
      document.getElementById("chatBox").style.display = "flex";
      currentPath = path;
      db.ref(path).on("child_added", displayMessage);
    }

    function displayMessage(snapshot) {
      const msg = snapshot.val();
      const messagesDiv = document.getElementById("messages");

      const time = new Date(msg.time || Date.now()).toLocaleTimeString();
      let content = `<div class="message"><strong>${msg.user}</strong> <small>${time}</small><br>`;

      if (msg.type === "text") {
        content += msg.text;
      } else if (msg.type === "image") {
        content += `<img src="${msg.url}" style="max-width: 100%;" />`;
      } else if (msg.type === "video") {
        content += `<video controls src="${msg.url}" style="max-width: 100%;"></video>`;
      }

      content += `</div>`;
      messagesDiv.innerHTML += content;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text) return;

      const msg = {
        user: user,
        text: text,
        time: Date.now(),
        type: "text"
      };

      db.ref(currentPath).push(msg);
      input.value = "";
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const storageRef = storage.ref("uploads/" + file.name);
      storageRef.put(file).then(snapshot => {
        snapshot.ref.getDownloadURL().then(url => {
          const msg = {
            user: user,
            time: Date.now(),
            type: file.type.startsWith("image") ? "image" : "video",
            url: url
          };
          db.ref(currentPath).push(msg);
        });
      });
    }

    // Show start screen on load
    window.onload = () => {
      document.getElementById("startScreen").style.display = "flex";
    };
  </script>

</body>
</html>
