<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube-Style Stream Platform</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #dashboard {
      width: 320px;
      background: #222;
      border-right: 2px solid #333;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #dashboard h2 {
      margin: 0 0 15px;
      color: #ffb400;
      font-weight: 600;
    }
    #user-info {
      margin-bottom: 15px;
      font-size: 0.9rem;
      word-break: break-word;
    }
    button {
      background: #ffb400;
      border: none;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-weight: bold;
      color: #121212;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #e6a500;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #streams-list {
      flex-grow: 1;
      overflow-y: auto;
      margin-top: 15px;
    }
    .stream-item {
      padding: 10px;
      border: 1px solid #444;
      margin-bottom: 10px;
      border-radius: 6px;
      background: #333;
    }
    .stream-item.live {
      border-color: #ff4d4d;
      background: #4d0000;
    }
    .stream-item h3 {
      margin: 0 0 6px;
      font-size: 1rem;
      color: #ffb400;
    }
    .stream-item small {
      color: #bbb;
    }
    .stream-actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
    }
    #main-view {
      flex-grow: 1;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
    }
    video, iframe {
      max-width: 90vw;
      max-height: 60vh;
      border-radius: 10px;
      background: black;
      box-shadow: 0 0 15px #ffb400cc;
    }
    #stream-title {
      margin: 15px 0 10px;
      font-size: 1.5rem;
      color: #ffb400;
    }
    #chat-container {
      width: 400px;
      background: #222;
      display: flex;
      flex-direction: column;
      padding: 15px;
      box-sizing: border-box;
      border-left: 2px solid #333;
    }
    #chat {
      flex-grow: 1;
      overflow-y: auto;
      background: #111;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 1.1rem;
      line-height: 1.4;
    }
    .chat-message {
      margin-bottom: 12px;
      word-wrap: break-word;
    }
    .chat-message strong {
      color: #ffb400;
    }
    #chat-input {
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #333;
      color: white;
    }
    #chat-input:disabled {
      background: #555;
      cursor: not-allowed;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="dashboard">
    <h2>Stream Dashboard</h2>
    <div id="user-info">Not signed in</div>
    <button id="signin-btn">Sign in with Google</button>
    <button id="create-stream-btn" disabled>Create Stream</button>
    <div id="streams-list"></div>
  </div>

  <div id="main-view">
    <div id="stream-title">Select a stream to watch</div>
    <video id="live-video" controls autoplay muted style="display:none"></video>
    <iframe id="prerecorded-video" controls style="display:none" frameborder="0" allowfullscreen></iframe>
  </div>

  <div id="chat-container">
    <div id="chat"></div>
    <input id="chat-input" placeholder="Type a message..." disabled />
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCq74S-8b4maDXEKkDXwoaz28Y_Qf0N_34",
    authDomain: "livestreamchat-268a9.firebaseapp.com",
    databaseURL: "https://livestreamchat-268a9-default-rtdb.firebaseio.com",
    projectId: "livestreamchat-268a9",
    storageBucket: "livestreamchat-268a9.firebasestorage.app",
    messagingSenderId: "761482927725",
    appId: "1:761482927725:web:7d525941da69c424bb6964"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Elements
  const signinBtn = document.getElementById('signin-btn');
  const userInfo = document.getElementById('user-info');
  const createStreamBtn = document.getElementById('create-stream-btn');
  const streamsList = document.getElementById('streams-list');
  const liveVideo = document.getElementById('live-video');
  const prerecordedVideo = document.getElementById('prerecorded-video');
  const streamTitle = document.getElementById('stream-title');
  const chat = document.getElementById('chat');
  const chatInput = document.getElementById('chat-input');

  const allowedStreamerEmail = "realgyjs@gmail.com";

  let currentUser = null;
  let currentStreamId = null;
  let screenStream = null;
  let chatMessagesRef = null;

  // UTIL: escape html
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Sign in
  signinBtn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      currentUser = result.user;
      userInfo.textContent = `Signed in as: ${currentUser.email}`;
      signinBtn.style.display = 'none';

      if(currentUser.email === allowedStreamerEmail) {
        createStreamBtn.disabled = false;
        userInfo.textContent += " (You can create streams)";
      } else {
        createStreamBtn.disabled = true;
        userInfo.textContent += " (View only)";
      }
      chatInput.disabled = false;
      listenStreams();
    } catch(e) {
      alert("Sign in failed: " + e.message);
    }
  };

  // Listen for streams in DB and update dashboard
  function listenStreams() {
    const streamsRef = db.ref('streams');
    streamsRef.on('value', snapshot => {
      const streams = snapshot.val() || {};
      streamsList.innerHTML = '';
      for(const id in streams) {
        const s = streams[id];
        const div = document.createElement('div');
        div.classList.add('stream-item');
        if(s.status === 'live') div.classList.add('live');

        div.innerHTML = `
          <h3>${escapeHtml(s.title)}</h3>
          <small>${s.status === 'live' ? 'Live' : 'Ended'} by ${escapeHtml(s.ownerEmail)}</small>
          <div class="stream-actions"></div>
        `;
        streamsList.appendChild(div);

        const actions = div.querySelector('.stream-actions');

        // Watch button
        const watchBtn = document.createElement('button');
        watchBtn.textContent = 'Watch';
        watchBtn.onclick = () => watchStream(id, s);
        actions.appendChild(watchBtn);

        // If owner and live: show end stream button
        if(currentUser && s.ownerEmail === currentUser.email && s.status === 'live') {
          const endBtn = document.createElement('button');
          endBtn.textContent = 'End Stream';
          endBtn.onclick = () => endStream(id);
          actions.appendChild(endBtn);
        }
      }
    });
  }

  // Create stream: live screen share or prerecorded URL prompt
  createStreamBtn.onclick = async () => {
    if(!currentUser) return alert("Sign in first.");
    const choice = prompt("Type 'live' for live screen share, or enter a prerecorded video URL:");

    if(!choice) return;

    if(choice.toLowerCase() === 'live') {
      // Start screen share
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
      } catch(e) {
        return alert("Screen share failed: " + e.message);
      }

      // Create live stream entry in DB
      const streamRef = db.ref('streams').push();
      const streamId = streamRef.key;
      const title = prompt("Enter your stream title:", "My Live Stream") || "Untitled Stream";

      await streamRef.set({
        title,
        ownerEmail: currentUser.email,
        status: 'live',
        createdAt: Date.now(),
        type: 'live'
      });

      // Show this live stream in main view
      watchStream(streamId, {
        title, ownerEmail: currentUser.email, status: 'live', type: 'live'
      });

      // Show the local screen share on video tag
      liveVideo.srcObject = screenStream;
      liveVideo.muted = true;
      liveVideo.style.display = 'block';
      prerecordedVideo.style.display = 'none';
      streamTitle.textContent = title;

      currentStreamId = streamId;

      // TODO: streaming video to viewers requires server or WebRTC signaling
      // For this demo, we just show local video only to streamer

      alert("Live stream created (local only demo). Real streaming requires backend and WebRTC.");

    } else {
      // Prerecorded video
      const videoURL = choice.trim();
      const title = prompt("Enter video title:", "Prerecorded Video") || "Untitled Video";

      // Save prerecorded stream in DB
      const streamRef = db.ref('streams').push();
      const streamId = streamRef.key;
      await streamRef.set({
        title,
        ownerEmail: currentUser.email,
        status: 'ended',
        createdAt: Date.now(),
        type: 'prerecorded',
        videoURL
      });

      alert("Prerecorded video added. Select it from dashboard to watch.");
    }
  };

  // End live stream
  async function endStream(streamId) {
    if(!currentUser) return;
    const streamRef = db.ref(`streams/${streamId}`);
    const snapshot = await streamRef.get();
    if(!snapshot.exists()) return alert("Stream not found");
    const stream = snapshot.val();
    if(stream.ownerEmail !== currentUser.email) return alert("Not your stream");

    await streamRef.update({status: 'ended'});

    if(currentStreamId === streamId) {
      // Stop local screen sharing stream
      if(screenStream) {
        screenStream.getTracks().forEach(t => t.stop());
        screenStream = null;
      }
      liveVideo.srcObject = null;
      liveVideo.style.display = 'none';
      prerecordedVideo.style.display = 'none';
      streamTitle.textContent = "Select a stream to watch";
      currentStreamId = null;
    }
  }

  // Watch stream
  async function watchStream(id, streamData) {
    currentStreamId = id;

    // Clear chat
    chat.innerHTML = '';
    if(chatMessagesRef) chatMessagesRef.off();

    streamTitle.textContent = streamData.title;

    if(streamData.type === 'live') {
      // Show live video tag, but actual remote live streaming is not implemented in this demo.
      liveVideo.style.display = 'block';
      prerecordedVideo.style.display = 'none';

      if(currentUser && currentUser.email === streamData.ownerEmail) {
        liveVideo.srcObject = screenStream;
      } else {
        liveVideo.srcObject = null;
        liveVideo.poster = '';
        liveVideo.controls = true;
        liveVideo.muted = false;
        liveVideo.src = ''; // No actual live stream feed for viewers in demo
        alert("Live streaming to viewers requires backend and WebRTC - not implemented in this demo.");
      }

    } else {
      // Show prerecorded iframe (YouTube or direct mp4 links)
      liveVideo.style.display = 'none';
      prerecordedVideo.style.display = 'block';
      // If it's a direct mp4 URL, use video tag instead (for demo simplicity we'll just embed)
      if(streamData.videoURL.match(/\.(mp4|webm|ogg)$/)) {
        // Use video tag for direct video files
        prerecordedVideo.style.display = 'none';
        liveVideo.style.display = 'block';
        liveVideo.srcObject = null;
        liveVideo.src = streamData.videoURL;
        liveVideo.controls = true;
        liveVideo.muted = false;
      } else {
        // Embed YouTube or other links in iframe
        prerecordedVideo.src = streamData.videoURL;
      }
    }

    // Enable chat input for signed-in users
    chatInput.disabled = !currentUser;

    if(currentUser) {
      // Listen to chat messages for this stream
      chatMessagesRef = db.ref(`chats/${id}`);
      chatMessagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        const msgEl = document.createElement('div');
        msgEl.classList.add('chat-message');
        msgEl.innerHTML = `<strong>${escapeHtml(msg.user)}:</strong> ${escapeHtml(msg.text)}`;
        chat.appendChild(msgEl);
        chat.scrollTop = chat.scrollHeight;
      });
    }
  }

  // Send chat message
  chatInput.addEventListener('keydown', async e => {
    if(e.key === 'Enter' && currentUser && currentStreamId && chatInput.value.trim()) {
      const msg = chatInput.value.trim();
      chatInput.value = '';
      const chatRef = db.ref(`chats/${currentStreamId}`);
      await chatRef.push({
        user: currentUser.email,
        text: msg,
        createdAt: Date.now()
      });
    }
  });

  // Auto-listen streams if signed in already
  auth.onAuthStateChanged(user => {
    if(user) {
      currentUser = user;
      userInfo.textContent = `Signed in as: ${user.email}`;
      signinBtn.style.display = 'none';
      createStreamBtn.disabled = user.email === allowedStreamerEmail ? false : true;
      listenStreams();
      chatInput.disabled = false;
    }
  });
</script>
</body>
</html>
