<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stream Creator & Dashboard with Chat</title>
<style>
  body {
    margin:0; padding:0; font-family: Arial, sans-serif; display: flex; height: 100vh; overflow: hidden;
  }
  #container {
    display: flex; width: 100%; height: 100%;
  }
  #mainVideo {
    flex: 0 0 60%; /* video width */
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }
  video, iframe {
    width: 100%;
    max-width: 560px;
    height: 315px;
    background: black;
    border-radius: 8px;
  }
  #chatSection {
    flex: 0 0 40%;
    background: #f1f1f1;
    display: flex;
    flex-direction: column;
    border-left: 2px solid #ccc;
    padding: 10px;
    overflow: hidden;
  }
  #chatMessages {
    flex: 1;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
  }
  #chatInput {
    display: flex;
  }
  #chatInput input {
    flex: 1;
    padding: 8px;
    border-radius: 8px 0 0 8px;
    border: 1px solid #ccc;
    border-right: none;
  }
  #chatInput button {
    padding: 8px 12px;
    border-radius: 0 8px 8px 0;
    border: 1px solid #ccc;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    border-left: none;
  }

  #dashboard {
    position: fixed;
    top: 10px; left: 10px;
    width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px #aaa;
    padding: 10px;
    z-index: 1000;
  }
  #dashboard h2 {
    margin-top: 0;
    text-align: center;
  }
  .stream-item {
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 10px;
    padding: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .stream-item img {
    width: 80px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
  }
  .stream-info {
    flex: 1;
  }
  .stream-title {
    font-weight: bold;
    font-size: 1rem;
    margin: 0;
  }
  .stream-desc {
    font-size: 0.85rem;
    color: #555;
    margin: 3px 0;
  }
  .stream-status {
    font-size: 0.75rem;
    font-weight: bold;
    color: green;
  }
  .stream-status.ended {
    color: red;
  }

  #createStreamForm {
    margin-bottom: 15px;
  }
  #createStreamForm input[type=text], #createStreamForm textarea {
    width: 100%;
    margin-bottom: 6px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  #createStreamForm input[type=file] {
    margin-bottom: 6px;
  }
  #createStreamForm button {
    width: 100%;
    padding: 8px;
    background-color: #28a745;
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #endStreamBtn {
    margin-top: 10px;
    padding: 8px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #signOutBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #555;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="dashboard">
  <h2>Streams Dashboard</h2>

  <!-- Owner Only: Create Stream -->
  <div id="createStreamForm" style="display:none;">
    <input type="text" id="streamTitleInput" placeholder="Stream Title" />
    <textarea id="streamDescInput" rows="3" placeholder="Stream Description"></textarea>
    <input type="file" id="thumbnailInput" accept="image/*" />
    <button id="startLiveBtn">Start Live Stream</button>
  </div>

  <div id="streamsList"></div>
</div>

<div id="container">
  <div id="mainVideo">
    <h2 id="watchTitle" style="margin: 10px 0;"></h2>
    <p id="watchDesc" style="margin: 0 0 15px;"></p>
    <img id="watchThumbnail" style="max-width: 100%; max-height: 180px; border-radius: 8px; display:none; margin-bottom: 10px;" />
    <video id="liveVideo" autoplay muted playsinline style="display:none; border-radius: 8px;"></video>
    <iframe id="prerecordedVideo" style="display:none;" frameborder="0" allowfullscreen></iframe>
    <button id="endStreamBtn" style="display:none;">End Stream</button>
  </div>

  <div id="chatSection">
    <h3>Live Chat</h3>
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="chatMessageInput" placeholder="Type a message..." />
      <button id="sendChatBtn">Send</button>
    </div>
  </div>
</div>

<button id="signOutBtn" style="display:none;">Sign Out</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // Your Firebase config here:
  const firebaseConfig = {
    apiKey: "AIzaSyCq74S-8b4maDXEKkDXwoaz28Y_Qf0N_34",
    authDomain: "livestreamchat-268a9.firebaseapp.com",
    databaseURL: "https://livestreamchat-268a9-default-rtdb.firebaseio.com",
    projectId: "livestreamchat-268a9",
    storageBucket: "livestreamchat-268a9.appspot.com",
    messagingSenderId: "761482927725",
    appId: "1:761482927725:web:7d525941da69c424bb6964"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  const streamsRef = db.ref('streams');
  let currentUser = null;
  let currentStreamId = null;
  let chatRef = null;

  // DOM Elements
  const createForm = document.getElementById('createStreamForm');
  const streamsList = document.getElementById('streamsList');
  const watchTitle = document.getElementById('watchTitle');
  const watchDesc = document.getElementById('watchDesc');
  const watchThumbnail = document.getElementById('watchThumbnail');
  const liveVideo = document.getElementById('liveVideo');
  const prerecordedVideo = document.getElementById('prerecordedVideo');
  const endStreamBtn = document.getElementById('endStreamBtn');

  const chatMessages = document.getElementById('chatMessages');
  const chatMessageInput = document.getElementById('chatMessageInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  const signOutBtn = document.getElementById('signOutBtn');

  // Login with Google
  async function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch(e) {
      alert('Sign in failed: ' + e.message);
    }
  }

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      signOutBtn.style.display = 'block';
      if(user.email === 'realgyjs@gmail.com') {
        createForm.style.display = 'block';
      } else {
        createForm.style.display = 'none';
      }
      loadStreamsDashboard();
    } else {
      signOutBtn.style.display = 'none';
      createForm.style.display = 'none';
      streamsList.innerHTML = '<p>Please <button onclick="signIn()">Sign in with Google</button> to use the app.</p>';
      clearWatch();
    }
  });

  signOutBtn.onclick = () => auth.signOut();

  // Load streams dashboard
  function loadStreamsDashboard() {
    streamsRef.off();
    streamsRef.on('value', snapshot => {
      const streams = snapshot.val() || {};
      streamsList.innerHTML = '';
      for(let id in streams) {
        const s = streams[id];
        const div = document.createElement('div');
        div.className = 'stream-item';
        div.innerHTML = `
          <img src="${escapeHtml(s.thumbnailURL || '')}" alt="Thumbnail" />
          <div class="stream-info">
            <p class="stream-title">${escapeHtml(s.title)}</p>
            <p class="stream-desc">${escapeHtml(s.description || '')}</p>
            <p class="stream-status ${s.status === 'ended' ? 'ended' : ''}">${s.status.toUpperCase()}</p>
          </div>
        `;
        div.onclick = () => watchStream(id, s);
        streamsList.appendChild(div);
      }
    });
  }

  // Watch Stream
  async function watchStream(streamId, stream) {
    currentStreamId = streamId;
    watchTitle.textContent = stream.title;
    watchDesc.textContent = stream.description || '';
    if(stream.thumbnailURL) {
      watchThumbnail.style.display = 'block';
      watchThumbnail.src = stream.thumbnailURL;
    } else {
      watchThumbnail.style.display = 'none';
    }

    if (stream.status === 'live') {
      // Assume stream.videoURL is a live HLS stream or webcam video URL, here we fake with webcam for demo
      prerecordedVideo.style.display = 'none';
      liveVideo.style.display = 'block';
      startFakeWebcam();
      if(currentUser.email === 'realgyjs@gmail.com') {
        endStreamBtn.style.display = 'inline-block';
      } else {
        endStreamBtn.style.display = 'none';
      }
    } else {
      liveVideo.style.display = 'none';
      endStreamBtn.style.display = 'none';
      if (stream.videoURL) {
        prerecordedVideo.style.display = 'block';
        prerecordedVideo.src = stream.videoURL;
      } else {
        prerecordedVideo.style.display = 'none';
      }
    }
    setupChat(streamId);
  }

  // Clear watch section
  function clearWatch() {
    watchTitle.textContent = '';
    watchDesc.textContent = '';
    watchThumbnail.style.display = 'none';
    liveVideo.style.display = 'none';
    prerecordedVideo.style.display = 'none';
    endStreamBtn.style.display = 'none';
    stopFakeWebcam();
    clearChat();
  }

  // Fake webcam stream for demo live video (since no actual streaming service here)
  let fakeStream = null;
  async function startFakeWebcam() {
    if(fakeStream) return;
    try {
      fakeStream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      liveVideo.srcObject = fakeStream;
      liveVideo.play();
    } catch(e) {
      alert('Unable to access webcam for live demo: ' + e.message);
    }
  }
  function stopFakeWebcam() {
    if(fakeStream) {
      fakeStream.getTracks().forEach(t=>t.stop());
      liveVideo.srcObject = null;
      fakeStream = null;
    }
  }

  // Create stream
  document.getElementById('startLiveBtn').onclick = async () => {
    const title = document.getElementById('streamTitleInput').value.trim();
    const desc = document.getElementById('streamDescInput').value.trim();
    const thumbnailFile = document.getElementById('thumbnailInput').files[0];

    if (!title) {
      alert('Title required');
      return;
    }
    if (!thumbnailFile) {
      alert('Thumbnail image required');
      return;
    }

    // Upload thumbnail
    const thumbRef = storage.ref('thumbnails/' + Date.now() + '_' + thumbnailFile.name);
    const uploadTask = thumbRef.put(thumbnailFile);
    uploadTask.on('state_changed', null, error => alert('Upload failed: '+error.message));
    await uploadTask;

    const thumbnailURL = await thumbRef.getDownloadURL();

    // Create stream entry
    const newStreamRef = streamsRef.push();
    await newStreamRef.set({
      title,
      description: desc,
      thumbnailURL,
      status: 'live',
      createdBy: currentUser.uid,
      createdAt: Date.now(),
      videoURL: null // For demo, no real video URL
    });

    // Reset form
    document.getElementById('streamTitleInput').value = '';
    document.getElementById('streamDescInput').value = '';
    document.getElementById('thumbnailInput').value = '';

    loadStreamsDashboard();
  };

  // End stream button (owner only)
  endStreamBtn.onclick = async () => {
    if(!currentStreamId) return;
    if(!confirm('Are you sure you want to end this live stream?')) return;

    await streamsRef.child(currentStreamId).update({
      status: 'ended',
      endedAt: Date.now(),
      // For demo, we set a prerecorded video URL
      videoURL: 'https://www.w3schools.com/html/mov_bbb.mp4'
    });

    loadStreamsDashboard();
    clearWatch();
  };

  // Chat system
  function setupChat(streamId) {
    if(chatRef) {
      chatRef.off();
    }
    chatMessages.innerHTML = '';
    chatRef = db.ref('chats/' + streamId);
    chatRef.on('child_added', snapshot => {
      const msg = snapshot.val();
      displayChatMessage(msg);
    });
  }
  function clearChat() {
    if(chatRef) {
      chatRef.off();
      chatRef = null;
    }
    chatMessages.innerHTML = '';
  }

  function displayChatMessage(msg) {
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `<strong>${escapeHtml(msg.name)}:</strong> ${escapeHtml(msg.text)}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendChatBtn.onclick = () => {
    if(!currentUser || !chatRef) {
      alert('Sign in and select a stream first');
      return;
    }
    const text = chatMessageInput.value.trim();
    if(!text) return;
    const msgData = {
      uid: currentUser.uid,
      name: currentUser.displayName || 'Anon',
      text,
      timestamp: Date.now()
    };
    chatRef.push(msgData);
    chatMessageInput.value = '';
  };

  // Utility escape HTML
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    })[m]);
  }
</script>

</body>
</html>
