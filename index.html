<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Dashboard + Chat</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #loginScreen {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #1e1e1e;
      flex-direction: column;
      gap: 10px;
    }
    button {
      background: #3a3a3a;
      border: none;
      color: #eee;
      padding: 8px 20px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    button:hover { background: #007bff; }
    button:disabled { background: #555; cursor: not-allowed; }

    #dashboard {
      display: none;
      flex: 1;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #mainArea {
      flex: 2;
      display: flex;
      flex-direction: column;
      background: #000;
      border-right: 2px solid #333;
      position: relative;
      overflow: hidden;
    }
    #livePreviewOwner, #livePreviewUser {
      width: 100%;
      height: 60vh;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #00ff99;
      padding: 20px;
      box-sizing: border-box;
    }
    video#ownerStreamVideo, video#userStreamVideo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
      border-radius: 6px;
      flex-grow: 1;
    }
    #liveInfo {
      margin-top: 12px;
      text-align: center;
    }
    #viewerCount {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #222;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 14px;
      color: #00ff99;
      user-select: none;
    }
    #createLiveForm {
      flex: 1;
      background: #1e1e1e;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    #createLiveForm input, #createLiveForm textarea {
      background: #222;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      color: #eee;
      resize: none;
    }
    #createLiveForm textarea {
      height: 80px;
    }
    #createLiveForm button {
      background: #007bff;
      font-weight: 700;
      margin-top: auto;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
      border-left: 2px solid #333;
      padding: 10px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      background: #121212;
      border-radius: 6px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: inset 0 0 10px #000;
      margin-bottom: 10px;
    }
    .chat-message {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      word-break: break-word;
    }
    .chat-message img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
      border: 2px solid #007bff;
      background: #222;
    }
    .chat-message span {
      color: #ccc;
    }
    .chat-message .owner {
      font-weight: 700;
      color: #00ff99;
    }
    #input-area {
      display: flex;
      margin-top: 10px;
      gap: 8px;
    }
    #msgInput {
      flex: 1;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      background: #222;
      color: #eee;
    }
    #msgInput:focus { outline: none; background: #333; }
    #sendBtn {
      flex-shrink: 0;
      padding: 10px 20px;
      border-radius: 6px;
      background: #007bff;
      font-weight: 600;
    }
    #sendBtn:hover { background: #0056b3; }
    em { color: #666; }
    #smallLivePreview {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 280px;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 0 10px #00ff99cc;
      padding: 12px;
      color: #00ff99;
      font-size: 14px;
      user-select: none;
      display: none;
      cursor: pointer;
      z-index: 999;
    }
    #smallLivePreview h4 {
      margin: 0 0 6px 0;
      font-weight: 700;
    }
    #smallLivePreview p {
      margin: 0;
      font-size: 12px;
      color: #aaffcc;
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <button id="loginBtn">Sign in with Google</button>
  </div>

  <div id="dashboard">
    <div id="mainArea">
      <!-- Owner create live form -->
      <div id="createLiveForm" style="display:none;">
        <h2>Create Live Stream</h2>
        <input type="text" id="liveName" placeholder="Live Stream Name" />
        <textarea id="liveDescription" placeholder="Live Stream Description"></textarea>
        <button id="createLiveBtn">Create & Share Screen</button>
      </div>

      <!-- Owner live preview -->
      <div id="livePreviewOwner" style="display:none; flex-direction: column;">
        <video id="ownerStreamVideo" autoplay muted playsinline></video>
        <div id="liveInfo">
          <h2 id="ownerLiveName"></h2>
          <p id="ownerLiveDesc"></p>
        </div>
        <div id="viewerCount">üëÅÔ∏è Viewers: 0</div>
      </div>

      <!-- Normal user live preview -->
      <div id="livePreviewUser" style="display:none; flex-direction: column; text-align: center;">
        <p><strong>Live Now:</strong></p>
        <div id="userLiveName" style="font-weight: 700; font-size: 18px;"></div>
        <div id="userLiveDesc" style="font-size: 14px; color: #aaa; margin-bottom: 8px;"></div>
        <p style="color:#666; font-size: 12px;">Live video preview is only visible to the owner.</p>
        <div id="viewerCountUser">üëÅÔ∏è Viewers: 0</div>
      </div>
    </div>

    <div id="chatArea">
      <div id="messages"><em>Please join a live stream to chat</em></div>
      <div id="input-area" style="display:none;">
        <input id="msgInput" type="text" placeholder="Type your message..." autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
      <button id="logoutBtn" style="margin-top:10px; background:#aa2222;">Logout</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCq74S-8b4maDXEKkDXwoaz28Y_Qf0N_34",
      authDomain: "livestreamchat-268a9.firebaseapp.com",
      databaseURL: "https://livestreamchat-268a9-default-rtdb.firebaseio.com",
      projectId: "livestreamchat-268a9",
      storageBucket: "livestreamchat-268a9.appspot.com",
      messagingSenderId: "761482927725",
      appId: "1:761482927725:web:7d525941da69c424bb6964"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const STREAM_OWNER_EMAIL = "realgyjs@gmail.com";

    // UI elements
    const loginScreen = document.getElementById('loginScreen');
    const loginBtn = document.getElementById('loginBtn');

    const dashboard = document.getElementById('dashboard');
    const logoutBtn = document.getElementById('logoutBtn');

    const createLiveForm = document.getElementById('createLiveForm');
    const liveNameInput = document.getElementById('liveName');
    const liveDescInput = document.getElementById('liveDescription');
    const createLiveBtn = document.getElementById('createLiveBtn');

    const livePreviewOwner = document.getElementById('livePreviewOwner');
    const ownerStreamVideo = document.getElementById('ownerStreamVideo');
    const ownerLiveName = document.getElementById('ownerLiveName');
    const ownerLiveDesc = document.getElementById('ownerLiveDesc');
    const viewerCount = document.getElementById('viewerCount');

    const livePreviewUser = document.getElementById('livePreviewUser');
    const userLiveName = document.getElementById('userLiveName');
    const userLiveDesc = document.getElementById('userLiveDesc');
    const viewerCountUser = document.getElementById('viewerCountUser');

    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const inputArea = document.getElementById('input-area');

    let currentUser = null;
    let liveStreamDataRef = null;
    let liveMessagesRef = null;
    let liveViewersRef = null;
    let viewerRef = null;
    let ownerStream = null;

    // Track if owner live is active
    let liveActive = false;

    // Login flow
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    };

    logoutBtn.onclick = () => {
      stopStreamingIfOwner();
      auth.signOut();
    };

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        loginScreen.style.display = 'none';
        dashboard.style.display = 'flex';
        if (user.email === STREAM_OWNER_EMAIL) {
          // Owner dashboard
          createLiveForm.style.display = 'flex';
          livePreviewOwner.style.display = 'none';
          livePreviewUser.style.display = 'none';
          inputArea.style.display = 'none';
          messagesDiv.innerHTML = '<em>Create a live stream to start chatting</em>';
          setupOwnerListeners();
        } else {
          // Normal user dashboard
          createLiveForm.style.display = 'none';
          livePreviewOwner.style.display = 'none';
          livePreviewUser.style.display = 'none';
          inputArea.style.display = 'none';
          messagesDiv.innerHTML = '<em>Waiting for a live stream...</em>';
          setupViewerListeners();
        }
      } else {
        currentUser = null;
        loginScreen.style.display = 'flex';
        dashboard.style.display = 'none';
        stopStreamingIfOwner();
        cleanupListeners();
      }
    });

    // Owner create live stream
    createLiveBtn.onclick = async () => {
      const name = liveNameInput.value.trim();
      const desc = liveDescInput.value.trim();
      if (!name) return alert("Enter a live stream name.");

      if (liveActive) {
        alert("You already have an active live stream.");
        return;
      }

      try {
        // Start screen capture
        ownerStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        ownerStreamVideo.srcObject = ownerStream;

        // Create live stream data in DB
        liveStreamDataRef = db.ref('liveStreams/owner');
        await liveStreamDataRef.set({
          name,
          description: desc,
          owner: currentUser.uid,
          startedAt: Date.now(),
          viewerCount: 0
        });

        // Setup messages and viewers refs
        liveMessagesRef = db.ref('liveMessages/owner');
        liveViewersRef = db.ref('liveViewers/owner');

        // Mark live active
        liveActive = true;

        // UI switch
        createLiveForm.style.display = 'none';
        livePreviewOwner.style.display = 'flex';
        inputArea.style.display = 'flex';
        messagesDiv.innerHTML = '';

        ownerLiveName.textContent = name;
        ownerLiveDesc.textContent = desc;
        updateViewerCountUI(0);

        setupChatListeners();
        setupViewerCountListeners();

        // Add self as viewer
        addViewer();

        // When stream ends (user stops sharing)
        ownerStream.getVideoTracks()[0].onended = () => {
          endLiveStream();
        };
      } catch (e) {
        alert("Failed to get screen capture: " + e.message);
      }
    };

    function updateViewerCountUI(count) {
      viewerCount.textContent = `üëÅÔ∏è Viewers: ${count}`;
      viewerCountUser.textContent = `üëÅÔ∏è Viewers: ${count}`;
    }

    function endLiveStream() {
      if (!liveActive) return;
      liveActive = false;

      // Remove live stream info
      if (liveStreamDataRef) liveStreamDataRef.remove();

      if (liveMessagesRef) liveMessagesRef.remove();
      if (liveViewersRef) liveViewersRef.remove();

      // Stop owner stream tracks
      if (ownerStream) {
        ownerStream.getTracks().forEach(t => t.stop());
        ownerStream = null;
      }

      // Reset UI
      createLiveForm.style.display = 'flex';
      livePreviewOwner.style.display = 'none';
      inputArea.style.display = 'none';
      messagesDiv.innerHTML = '<em>Create a live stream to start chatting</em>';
      liveNameInput.value = '';
      liveDescInput.value = '';
      ownerLiveName.textContent = '';
      ownerLiveDesc.textContent = '';
    }

    // Clean up listeners on logout or end live
    function cleanupListeners() {
      if (liveStreamDataRef) liveStreamDataRef.off();
      if (liveMessagesRef) liveMessagesRef.off();
      if (liveViewersRef) liveViewersRef.off();
      if (viewerRef) {
        viewerRef.remove();
        viewerRef = null;
      }
    }

    function stopStreamingIfOwner() {
      if (currentUser && currentUser.email === STREAM_OWNER_EMAIL) {
        endLiveStream();
      }
    }

    // Chat functionality
    function setupChatListeners() {
      if (!liveMessagesRef) return;

      liveMessagesRef.off();
      liveMessagesRef.on('child_added', (snapshot) => {
        const data = snapshot.val();
        addMessageToChat(data);
      });
    }

    function addMessageToChat({uid, displayName, photoURL, text}) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('chat-message');
      const avatar = document.createElement('img');
      avatar.src = photoURL || 'https://www.gravatar.com/avatar?d=mp&s=32';
      avatar.alt = displayName || 'User';
      const msgText = document.createElement('span');
      msgText.innerHTML = `<strong>${displayName || 'User'}</strong>: ${escapeHTML(text)}`;
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(msgText);
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    sendBtn.onclick = () => {
      sendMessage();
    };

    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text || !liveMessagesRef) return;
      const msgObj = {
        uid: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        text
      };
      liveMessagesRef.push(msgObj);
      msgInput.value = '';
    }

    // Viewer count tracking
    function setupViewerCountListeners() {
      if (!liveViewersRef) return;

      liveViewersRef.on('value', (snap) => {
        const count = snap.numChildren() || 0;
        updateViewerCountUI(count);
      });
    }

    // Add self as viewer to liveViewers node and remove on disconnect
    function addViewer() {
      if (!liveViewersRef || !currentUser) return;
      viewerRef = liveViewersRef.push();
      viewerRef.set({ uid: currentUser.uid, timestamp: Date.now() });
      viewerRef.onDisconnect().remove();
    }

    // Owner listeners for live stream data removal and viewer count
    function setupOwnerListeners() {
      // Listen if live stream is removed (for example, force removed by another device)
      db.ref('liveStreams/owner').on('value', snapshot => {
        if (!snapshot.exists() && liveActive) {
          alert("Live stream ended.");
          endLiveStream();
        }
      });
    }

    // Viewer listeners to watch if live stream is active
    function setupViewerListeners() {
      db.ref('liveStreams/owner').on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          // Live is active, show info & chat
          livePreviewUser.style.display = 'flex';
          inputArea.style.display = 'flex';
          messagesDiv.innerHTML = '';
          userLiveName.textContent = data.name || 'Live Stream';
          userLiveDesc.textContent = data.description || '';
          livePreviewOwner.style.display = 'none';
          createLiveForm.style.display = 'none';

          // Setup chat and viewers refs
          liveMessagesRef = db.ref('liveMessages/owner');
          liveViewersRef = db.ref('liveViewers/owner');

          setupChatListeners();
          setupViewerCountListeners();

          addViewer();
        } else {
          // No live stream active
          livePreviewUser.style.display = 'none';
          inputArea.style.display = 'none';
          messagesDiv.innerHTML = '<em>Waiting for a live stream...</em>';
          if (liveMessagesRef) liveMessagesRef.off();
          if (liveViewersRef) liveViewersRef.off();
          if (viewerRef) {
            viewerRef.remove();
            viewerRef = null;
          }
        }
      });
    }

    // Simple escape HTML
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (m) => {
        switch(m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return m;
        }
      });
    }
  </script>
</body>
</html>
